<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Lumina Admin Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/svg+xml" href="/logo.svg" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* =============================== */
    /*     Lumina Premium Theme        */
    /* =============================== */

    :root {
      --bg-page: #030712;
      --bg-card: #0F1116;
      --bg-input: #1A1D24;
      --border: #2A2E37;

      --text-main: #F3F4F6;
      --text-muted: #9CA3AF;

      --primary: #06B6D4;
      --primary-hover: #0891B2;

      --danger: #EF4444;
      --success: #10B981;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: var(--bg-page);
      color: var(--text-main);
      padding-bottom: 60px;
      min-height: 100vh;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(6, 182, 212, 0.08), transparent 30%),
        radial-gradient(circle at 90% 80%, rgba(59, 130, 246, 0.08), transparent 30%);
      background-attachment: fixed;
    }

    /* NAVBAR */
    .navbar {
      background: rgba(15, 17, 22, 0.8);
      backdrop-filter: blur(12px);
      height: 80px;
      padding: 0 40px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand-logo {
      display: none;
      /* User requested no image logo, relying on text/icon only if needed or just removing it */
    }

    .brand-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #06B6D4 0%, #3B82F6 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(6, 182, 212, 0.4);
    }

    .brand-name {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      letter-spacing: -0.5px;
    }

    .brand-badge {
      background: rgba(6, 182, 212, 0.1);
      color: var(--primary);
      font-size: 10px;
      font-weight: 700;
      padding: 4px 8px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: 1px solid rgba(6, 182, 212, 0.2);
    }

    .nav-back {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      padding: 10px 18px;
      border-radius: 10px;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .nav-back:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--border);
    }

    /* CONTAINER */
    .container {
      max-width: 1100px;
      margin: 40px auto;
      padding: 0 24px;
    }

    /* TABS */
    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 30px;
      background: var(--bg-card);
      padding: 6px;
      border-radius: 12px;
      border: 1px solid var(--border);
      display: inline-flex;
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 10px 24px;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: var(--text-main);
    }

    .tab-btn.active {
      background: var(--bg-input);
      color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .tab-btn.active::after {
      display: none;
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.4s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* CARDS */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3);
    }

    .card-header {
      margin-bottom: 32px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 20px;
    }

    .card h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #fff;
      letter-spacing: -0.5px;
    }

    .card p {
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.6;
    }

    /* FORMS */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 32px;
    }

    .form-field label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-field input,
    .form-field select {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: #fff;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.2s;
      outline: none;
    }

    .form-field input:focus,
    .form-field select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
    }

    /* ASSIGNMENT ROWS */
    .grant-row {
      display: flex;
      gap: 20px;
      align-items: flex-end;
      background: #15181E;
      padding: 20px;
      border-radius: 14px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .btn-remove {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
      width: 48px;
      height: 48px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
      font-size: 18px;
    }

    .btn-remove:hover {
      background: var(--danger);
      color: white;
    }

    /* BUTTONS */
    .btn {
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border: none;
      transition: 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #06B6D4 0%, #3B82F6 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(6, 182, 212, 0.4);
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-input);
      border-color: var(--text-muted);
      color: #fff;
    }

    /* PERMISSION TABLE */
    .perm-table-wrap {
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: var(--bg-input);
    }

    .perm-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .perm-table th {
      background: #15181E;
      text-align: left;
      color: var(--text-muted);
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
    }

    .perm-table td {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      color: var(--text-main);
    }

    .perm-table tr:last-child td {
      border-bottom: none;
    }

    .perm-table tr:hover td {
      background: rgba(255, 255, 255, 0.03);
    }

    /* CHECKBOXES */
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary);
      border-radius: 4px;
    }

    /* TOAST */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      right: auto;
      transform: translateX(-50%) translateY(-200%);
      padding: 12px 24px;
      border-radius: 50px;
      background: rgba(6, 182, 212, 0.1);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(6, 182, 212, 0.2);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      color: #fff;
      font-weight: 500;
      font-size: 14px;
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 10px;
      pointer-events: none;
      /* Prevent blocking interaction when hidden */
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
      opacity: 1;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }
  </style>
</head>

<body>

  <div class="navbar">
    <div class="brand">
      <div class="brand-icon">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
        </svg>
      </div>
      <div class="brand-name">LUMINA</div>
      <div class="brand-badge">ADMIN</div>
    </div>
    <a href="/" class="nav-back">Return to Workspace</a>
  </div>

  <div class="container">

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('users')">User Management</button>
      <button class="tab-btn" onclick="switchTab('roles')">Access Control Matrix</button>
    </div>

    <!-- TAB 1: USER ASSIGNMENT -->
    <div id="tab-users" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2>Configure User Access</h2>
          <p>Manage user identities and their project assignments. Enter the user details below.</p>
        </div>

        <form id="userForm">
          <div class="form-grid">
            <div class="form-field">
              <label>Email Address</label>
              <input type="email" id="userEmail" required placeholder="name@ariqt.com" autocomplete="off"
                pattern="[a-zA-Z0-9._%+-]+@ariqt\.com$" title="Only @ariqt.com emails are allowed">
            </div>
            <div class="form-field">
              <label>Full Name</label>
              <input type="text" id="userName" required placeholder="e.g. John Doe" autocomplete="off">
            </div>
          </div>

          <div style="margin: 30px 0 15px; display:flex; justify-content:space-between; align-items:center;">
            <label
              style="font-size:14px; font-weight:700; color:var(--text-main); text-transform:uppercase; letter-spacing:0.5px;">Assigned
              Projects</label>
            <span id="projectCount" style="font-size:13px; color:var(--text-muted);">0 assigned</span>
          </div>

          <div id="grantsContainer">
            <!-- Dynamic Rows -->
          </div>

          <button type="button" id="addProjectBtn" class="btn btn-secondary" onclick="addGrantRow()"
            style="margin-top: 10px; width:100%; border-style:dashed; padding: 16px;">
            + Grant Access to Another Project
          </button>

          <div style="margin-top: 40px; padding-top:20px; border-top:1px solid var(--border); text-align: right;">
            <button type="submit" class="btn btn-primary">Save User Configuration</button>
          </div>
        </form>
      </div>
    </div>

    <!-- TAB 2: ROLE DEFINITIONS -->
    <div id="tab-roles" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2>Role Permissions</h2>
          <p>Define granular data access policies for each role. Select a project and role to edit permissions.</p>
        </div>

        <div class="form-grid">
          <div class="form-field">
            <label>Project Scope</label>
            <select id="permProject" onchange="loadPermissions()">
              <option value="">-- Select Project --</option>
            </select>
          </div>
          <div class="form-field">
            <label>Target Role</label>
            <select id="permRole" onchange="loadPermissions()">
              <option value="">-- Select Role --</option>
            </select>
          </div>
        </div>

        <div id="permEditor" style="display:none; animation: fadeIn 0.4s ease;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <label style="font-size:14px; font-weight:600; color:var(--text-muted);">Table Permissions</label>
            <div style="display:flex; gap:10px;">
              <button type="button" class="btn btn-secondary" style="padding:8px 16px; font-size:13px"
                onclick="permBulk(true, false)">Check All Read</button>
              <button type="button" class="btn btn-secondary" style="padding:8px 16px; font-size:13px"
                onclick="permBulk(false, false)">Uncheck All Read</button>
            </div>
          </div>

          <div class="perm-table-wrap">
            <table class="perm-table">
              <thead>
                <tr>
                  <th>Data Resource (Table)</th>
                  <th width="150" style="text-align:center;">Read Access</th>
                  <th width="150" style="text-align:center;">Self-Only Data</th>
                </tr>
              </thead>
              <tbody id="permBody"></tbody>
            </table>
          </div>

          <div style="margin-top: 32px; text-align: right;">
            <button class="btn btn-primary" onclick="savePermissions()">Update Permissions</button>
          </div>
        </div>

      </div>
    </div>

  </div>

  <div id="toast" class="toast">Action Successful</div>

  <script>
    /* ================= STATE ================= */
    let meta = { projects: [], roles: [], tables: [] };
    let usedProjects = new Set();

    /* ================= INIT ================= */
    async function init() {
      try {
        // 1. Fetch Bootstrap Data (Users, Roles)
        const bootRes = await fetch('/api/admin/bootstrap');
        const bootData = await bootRes.json();
        meta.roles = bootData.roles || [];

        // 2. Fetch Projects Dynamically
        const projRes = await fetch('/api/admin/projects');
        meta.projects = await projRes.json();

        // Populate UI Selectors
        populateSelect('permProject', meta.projects.map(p => p.ProjectName));
        populateSelect('permRole', meta.roles.map(r => r.RoleName));

        // Initialize User Tab
        addGrantRow();
        updateProjectUI();
      } catch (e) {
        console.error("Initialization error:", e);
        showToast("Failed to load system data", false);
      }
    }

    function populateSelect(id, items) {
      const el = document.getElementById(id);
      el.innerHTML = '<option value="">-- Select --</option>' +
        items.map(i => `<option value="${i}">${i}</option>`).join('');
    }

    /* ================= TABS ================= */
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

      document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    /* ================= USER MANAGEMENT LOGIC ================= */
    function addGrantRow(selectedProject = "", selectedRole = "") {
      // 1. Validation: Max Projects
      if (document.querySelectorAll('.grant-row').length >= meta.projects.length) {
        return;
      }

      const container = document.getElementById('grantsContainer');
      const div = document.createElement('div');
      div.className = 'grant-row';

      const projectOptions = meta.projects.map(p =>
        `<option value="${p.ProjectName}" ${p.ProjectName === selectedProject ? 'selected' : ''}>${p.ProjectName}</option>`
      ).join('');

      const roleOptions = meta.roles.map(r =>
        `<option>${r.RoleName}</option>`
      ).join('');

      div.innerHTML = `
    <div style="flex:1">
      <label style="font-size:12px; color:var(--text-muted); display:block; margin-bottom:8px; font-weight:600;">Project</label>
      <div class="form-field" style="margin-bottom:0;"><select class="grant-project" onchange="validateProjects()">${projectOptions}</select></div>
    </div>
    <div style="flex:1">
      <label style="font-size:12px; color:var(--text-muted); display:block; margin-bottom:8px; font-weight:600;">Assigned Role</label>
      <div class="form-field" style="margin-bottom:0;"><select class="grant-role">${roleOptions}</select></div>
    </div>
    <button type="button" class="btn-remove" onclick="removeRow(this)" title="Remove Access">âœ•</button>
  `;

      container.appendChild(div);
      updateProjectUI();
    }

    function removeRow(btn) {
      btn.closest('.grant-row').remove();
      updateProjectUI();
    }

    function updateProjectUI() {
      const rowCount = document.querySelectorAll('.grant-row').length;
      const max = meta.projects.length;

      document.getElementById('projectCount').textContent = `${rowCount} / ${max} projects assigned`;

      const btn = document.getElementById('addProjectBtn');
      if (rowCount >= max) {
        btn.disabled = true;
        btn.textContent = "All Available Projects Assigned";
      } else {
        btn.disabled = false;
        btn.textContent = "+ Grant Access to Another Project";
      }
    }

    function validateProjects() {
      const selects = document.querySelectorAll('.grant-project');
      const selected = new Set();
      let hasDup = false;

      selects.forEach(s => {
        if (selected.has(s.value)) hasDup = true;
        selected.add(s.value);
      });

      if (hasDup) {
        showToast("Warning: You selected the same project twice.", false);
      }
    }

    /* API: SAVE USER */
    document.getElementById('userForm').onsubmit = async (e) => {
      e.preventDefault();

      const email = document.getElementById('userEmail').value.trim();
      const name = document.getElementById('userName').value.trim();

      // Validation
      if (!email || !name) { showToast("Email and Name are required", false); return; }

      // Gather Grants
      const grants = [];
      const seenProjects = new Set();
      let error = null;

      document.querySelectorAll('.grant-row').forEach(row => {
        const p = row.querySelector('.grant-project').value;
        const r = row.querySelector('.grant-role').value;

        if (seenProjects.has(p)) error = `Duplicate project selected: ${p}`;
        seenProjects.add(p);

        grants.push({ project: p, role: r });
      });

      if (error) { showToast(error, false); return; }
      if (grants.length === 0) { showToast("Please assign at least one project", false); return; }

      try {
        const res = await fetch('/api/admin/assign-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, name, grants })
        });
        const data = await res.json();

        if (data.error) throw new Error(data.error);

        showToast('User Configuration Saved Successfully!', true);

        // Reset Form
        document.getElementById('userForm').reset();
        document.getElementById('grantsContainer').innerHTML = '';
        addGrantRow(); // Add one empty row back

      } catch (err) {
        showToast(err.message, false);
      }
    };

    /* ================= PERMISSION EDITOR LOGIC ================= */
    async function loadPermissions() {
      const project = document.getElementById('permProject').value;
      const role = document.getElementById('permRole').value;
      const editor = document.getElementById('permEditor');
      const tbody = document.getElementById('permBody');

      if (!project || !role) {
        editor.style.display = 'none';
        return;
      }

      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:30px; color:var(--text-muted);">Syncing schema from project database...</td></tr>';
      editor.style.display = 'block';

      try {
        // 1. Fetch live tables from project database
        const tableRes = await fetch(`/api/admin/tables?project=${encodeURIComponent(project)}`);
        const projectTables = await tableRes.json();

        if (projectTables.error) throw new Error(projectTables.error);

        // 2. Fetch existing role permissions
        const res = await fetch(`/api/admin/role-permissions?project=${encodeURIComponent(project)}&role=${encodeURIComponent(role)}`);
        const currentPerms = await res.json();
        const permMap = {};
        currentPerms.forEach(p => { permMap[p.TableName] = p; });

        if (projectTables.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:30px; color:var(--text-muted);">No tables found for this project.</td></tr>';
        } else {
          tbody.innerHTML = projectTables.map(t => {
            const p = permMap[t] || { CanRead: false, CanReadSelf: false };
            return `
          <tr>
            <td><span style="font-family:monospace; font-size:14px;">${t}</span></td>
            <td style="text-align:center;">
              <input type="checkbox" class="cb-read" data-table="${t}" ${p.CanRead ? 'checked' : ''}>
            </td>
            <td style="text-align:center;">
              <input type="checkbox" class="cb-self" data-table="${t}" ${p.CanReadSelf ? 'checked' : ''}>
            </td>
          </tr>
        `;
          }).join('');
        }
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:30px; color:var(--danger);">Error: ${err.message}</td></tr>`;
      }
    }

    function permBulk(checked, isSelf) {
      const cls = isSelf ? '.cb-self' : '.cb-read';
      document.querySelectorAll(cls).forEach(cb => cb.checked = checked);
    }

    async function savePermissions() {
      const project = document.getElementById('permProject').value;
      const role = document.getElementById('permRole').value;

      const permissions = [];
      document.querySelectorAll('#permBody tr').forEach(row => {
        if (!row.querySelector('.cb-read')) return;

        const table = row.querySelector('.cb-read').dataset.table;
        const canRead = row.querySelector('.cb-read').checked;
        const canReadSelf = row.querySelector('.cb-self').checked;

        if (canRead || canReadSelf) {
          permissions.push({ table, canRead, canReadSelf });
        }
      });

      try {
        const res = await fetch('/api/admin/update-permissions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ project, role, permissions })
        });
        const data = await res.json();

        if (data.error) throw new Error(data.error);
        showToast('Role Permissions Updated Successfully!', true);

      } catch (err) {
        showToast(err.message, false);
      }
    }

    /* ================= UTILS ================= */
    function showToast(msg, success) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast visible ${success ? 'success' : 'error'}`;
      setTimeout(() => t.classList.remove('visible'), 3000);
    }

    // Start
    init();

  </script>
</body>

</html>